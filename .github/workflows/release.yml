name: ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  # å…è®¸ä» GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # =======================================================
  # JOB 1: æ ¡éªŒç‰ˆæœ¬å·
  # =======================================================
  validate:
    name: 1. æ ¡éªŒç‰ˆæœ¬å· (Validate Version)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      new_tag: ${{ steps.compare.outputs.new_tag }}
      old_tag: ${{ steps.latest_tag.outputs.tag }}

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout repo)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # å¿…é¡»è·å–æ‰€æœ‰ tags æ‰èƒ½æ¯”è¾ƒ

      - name: è¯»å– tauri.conf.json ç‰ˆæœ¬ (Read tauri.conf.json version)
        id: tauri_version
        run: |
          # ä» json ä¸­æå– "version": "0.1.1" -> 0.1.1
          VERSION=$(jq -r '.version' ./src-tauri/tauri.conf.json)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT

      - name: è·å–æœ€æ–°çš„ Git Tag (Get latest Git tag)
        id: latest_tag
        run: |
          # 1. åˆ—å‡ºæ‰€æœ‰ tags
          # 2. Grep ç­›é€‰å‡ºä¸¥æ ¼çš„ vX.Y.Z æ ¼å¼ (ä¾‹å¦‚ v0.1.0, v1.2.3)ï¼Œå¿½ç•¥ 'alpha' ç­‰
          # 3. æŒ‰ç‰ˆæœ¬å·æ’åº (sort -V)
          # 4. å–æœ€åä¸€ä¸ª (å³ç‰ˆæœ¬æœ€é«˜çš„)
          # 5. å¦‚æœæ²¡æœ‰æ‰¾åˆ° (ä¾‹å¦‚ç¬¬ä¸€æ¬¡å‘å¸ƒ)ï¼Œåˆ™é»˜è®¤ä¸º v0.0.0
          LATEST_TAG=$(git tag | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1 || echo "v0.0.0")
          echo "æ‰¾åˆ°çš„æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ Tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒç‰ˆæœ¬å· (Compare versions)
        id: compare
        run: |
          APP_VERSION=${{ steps.tauri_version.outputs.app_version }}
          LATEST_TAG_VERSION=${{ steps.latest_tag.outputs.tag }}
          LATEST_TAG_VERSION_NUM=${LATEST_TAG_VERSION#v} # å»æ‰ 'v' -> 0.1.0
          
          echo "App ç‰ˆæœ¬ (Current): $APP_VERSION"
          echo "Git Tag ç‰ˆæœ¬ (Latest): $LATEST_TAG_VERSION_NUM"
          
          if [ "$APP_VERSION" = "$LATEST_TAG_VERSION_NUM" ]; then
            echo "::error::tauri.conf.json ç‰ˆæœ¬ ($APP_VERSION) ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–° tauri.conf.jsonã€‚"
            exit 1
          fi
          
          # ä½¿ç”¨ sort -V æ¥å®‰å…¨åœ°æ¯”è¾ƒç‰ˆæœ¬å·
          LATEST_VERSION=$(printf "%s\n%s" "$APP_VERSION" "$LATEST_TAG_VERSION_NUM" | sort -V | tail -n 1)
          
          if [ "$LATEST_VERSION" != "$APP_VERSION" ]; then
            echo "::error::tauri.conf.json ç‰ˆæœ¬ ($APP_VERSION) å°äºæˆ–ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–° tauri.conf.jsonã€‚"
            exit 1
          fi
          
          echo "ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ (Validation passed)!"
          echo "new_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=v$APP_VERSION" >> $GITHUB_OUTPUT

  # =======================================================
  # JOB 2: æ„å»ºå¹¶å‘å¸ƒ Release
  # =======================================================
  build_and_release:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: aarch64-linux-android
    name: 2. æ„å»ºå¹¶å‘å¸ƒ (Build and Release)
    if: github.ref == 'refs/heads/main'
    needs: validate # ä¾èµ– validate job æˆåŠŸ
    runs-on: ${{ matrix.os }}
    steps:
      - name: å…‹éš†å½“å‰ä»“åº“ (Clone current repo)
        uses: actions/checkout@v5

      - name: å®‰è£…ä¾èµ–(Install dependencies)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: å®‰è£… Rust (Install Rust)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust ç¼“å­˜ (Rust cache)
        uses: swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.target }}
          workspaces: './src-tauri -> target'

      - name: å®‰è£… pnpm (Install pnpm)
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: å®‰è£… Node.js (Install Node.js)
        uses: actions/setup-node@v6
        with:
          node-version: "24.x"
          cache: "pnpm"

      - name: å®‰è£…å‰ç«¯ä¾èµ– (Install frontend dependencies)
        run: pnpm install

      - name: å®‰è£… rust target (Install rust target)
        run: rustup target add ${{ matrix.target }}

      - name: å®‰è£… Java (Install Java)
        uses: actions/setup-java@v5
        with:
          distribution: 'liberica'
          java-version: '21'

      - name: å®‰è£… Android SDK (Setup Android SDK)
        uses: android-actions/setup-android@v3

      - name: å®‰è£… NDK (Install NDK)
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27d
          add-to-path: false
          link-to-sdk: true

      - name: åˆ›å»º keystore (Create keystore)
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        working-directory: src-tauri/gen/android
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/keystore.jks
          # åˆ›å»º keystore.properties æ–‡ä»¶
          cat > keystore.properties << EOF
          password=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=upload
          storeFile=keystore.jks
          EOF

      - name: æ„å»ºåº”ç”¨ (Build app)
        run: |
          pnpm tauri android build --apk --target aarch64
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: é‡å‘½å APK (Rename APK)
        id: rename_apk
        run: |
          VERSION=${{ needs.validate.outputs.new_version }}
          ORIGINAL_PATH="./src-tauri/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk"
          NEW_NAME="sync-clipboard-tauri-${VERSION}-arm64v8.apk"
          mv $ORIGINAL_PATH ./$NEW_NAME
          echo "apk_path=./$NEW_NAME" >> $GITHUB_OUTPUT

      - name: è¯»å– Unreleased Changelog (Read Unreleased Changelog)
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: 'Unreleased' # å‘å¸ƒæ—¶ï¼Œæ–°ç‰ˆæœ¬çš„å†…å®¹ä»åœ¨ Unreleased å—ä¸­
          path: './CHANGELOG.md'

      - name: æå– Unreleased å¯¹æ¯”é“¾æ¥ (Extract Unreleased Compare Link)
        id: changelog_link
        run: |
          URL=$(grep "\[Unreleased\]:" CHANGELOG.md | awk '{print $2}')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release (Create GitHub Release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.validate.outputs.new_tag }} # e.g., v0.1.1
          name: ${{ needs.validate.outputs.new_tag }}
          body: |
            ${{ steps.changelog_reader.outputs.description || steps.changelog_reader.outputs.changes }}

            ---
            **Full Changelog**: ${{ steps.changelog_link.outputs.url }}
          prerelease: false # è¿™æ˜¯æ­£å¼ç‰ˆ
          artifacts: ${{ steps.rename_apk.outputs.apk_path }} # ä¸Šä¼ é‡å‘½ååçš„ APK

  # =======================================================
  # JOB 3: æ›´æ–° CHANGELOG å¹¶åˆ›å»º PR
  # =======================================================
  update_changelog:
    name: 3. æ›´æ–° CHANGELOG å¹¶åˆ›å»º PR (Update CHANGELOG)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build_and_release] # å¿…é¡»åœ¨å‘å¸ƒæˆåŠŸåè¿è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: å…‹éš†ä»“åº“ (Checkout repo)
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GITHUB_TOKEN

      - name: é…ç½® Git (Configure Git)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # --- è¿™æ˜¯è¢«ä¿®æ­£çš„æ­¥éª¤ ---
      - name: æ›´æ–° CHANGELOG.md (Update CHANGELOG.md)
        env:
          NEW_VERSION: ${{ needs.validate.outputs.new_version }}
          NEW_TAG: ${{ needs.validate.outputs.new_tag }}
          OLD_TAG: ${{ needs.validate.outputs.old_tag }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" 
          FILE="./CHANGELOG.md"

          # 1. å‡†å¤‡æ–°é“¾æ¥
          NEW_UNRELEASED_LINK_LINE="[Unreleased]: ${REPO_URL}/compare/${NEW_TAG}...HEAD"
          NEW_VERSION_LINK_LINE="[${NEW_VERSION}]: ${REPO_URL}/commits/${NEW_TAG}"

          # 2. æ›¿æ¢ [Unreleased] æ ‡é¢˜ä¸ºæ–°ç‰ˆæœ¬æ ‡é¢˜
          sed -i.bak "s|## \[Unreleased\]|## \[${NEW_VERSION}\] - ${TODAY}|" $FILE

          # 3. åœ¨æ–‡ä»¶ä¸»æ ‡é¢˜ (# ...) ä¸‹æ–¹æ·»åŠ æ–°çš„ [Unreleased] å—
          #    (ä¿®å¤ï¼šä¸åœ¨ç¬¬1è¡Œæ’å…¥ï¼Œè€Œæ˜¯åœ¨æ ‡é¢˜è¡Œåæ’å…¥)
          sed -i.bak "/^# .*/a \\
          \\
          ## [Unreleased]
          " $FILE
          
                  # 4. æ›¿æ¢æ—§çš„ Unreleased é“¾æ¥
                  sed -i.bak "s|^\[Unreleased\]:.*|${NEW_UNRELEASED_LINK_LINE}|" $FILE
          
          # 5. åœ¨ Unreleased é“¾æ¥ *ä¸‹é¢* æ·»åŠ æ–°ç‰ˆæœ¬çš„é“¾æ¥
          #    (ä¿®å¤ï¼šç¡®ä¿å¤šè¡Œ 'a\' å‘½ä»¤çš„å¥å£®æ€§)
          sed -i.bak "/^\[Unreleased\]:/a ${NEW_VERSION_LINK_LINE}" $FILE
          
          # 6. åˆ é™¤å¤‡ä»½æ–‡ä»¶
          rm -f $FILE.bak
          
          echo "--- CHANGELOG.md after update: ---"
            cat $FILE
            echo "-----------------------------------"
          # --- ä¿®æ­£ç»“æŸ ---

      - name: åˆ›å»º PR åˆ° dev åˆ†æ”¯ (Create PR to dev)
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          branch: "chore/update-changelog-${{ needs.validate.outputs.new_version }}"
          base: "dev" # ç›®æ ‡åˆ†æ”¯æ˜¯ dev
          title: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          body: |
            è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}
          delete-branch: true
