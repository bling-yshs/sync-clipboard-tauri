name: ğŸš€ å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  # å…è®¸ä» GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # =======================================================
  # JOB 1: æ ¡éªŒç‰ˆæœ¬å·
  # =======================================================
  validate:
    name: 1. æ ¡éªŒç‰ˆæœ¬å· (Validate Version)
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.compare.outputs.new_version }}
      new_tag: ${{ steps.compare.outputs.new_tag }}
      old_tag: ${{ steps.latest_tag.outputs.tag }}

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout repo)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # å¿…é¡»è·å–æ‰€æœ‰ tags æ‰èƒ½æ¯”è¾ƒ

      - name: è¯»å– pubspec.yaml ç‰ˆæœ¬ (Read pubspec.yaml version)
        id: pubspec_version
        run: |
          # ä» pubspec.yaml ä¸­æå–ç‰ˆæœ¬å·ï¼Œæ ¼å¼å¦‚ "version: 0.2.1+2"
          VERSION=$(grep -E "^version:" pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT

      - name: è·å–æœ€æ–°çš„ Git Tag (Get latest Git tag)
        id: latest_tag
        run: |
          # 1. åˆ—å‡ºæ‰€æœ‰ tags
          # 2. Grep ç­›é€‰å‡ºä¸¥æ ¼çš„ vX.Y.Z æ ¼å¼ (ä¾‹å¦‚ v0.1.0, v1.2.3)ï¼Œå¿½ç•¥ 'alpha' ç­‰
          # 3. æŒ‰ç‰ˆæœ¬å·æ’åº (sort -V)
          # 4. å–æœ€åä¸€ä¸ª (å³ç‰ˆæœ¬æœ€é«˜çš„)
          # 5. å¦‚æœæ²¡æœ‰æ‰¾åˆ° (ä¾‹å¦‚ç¬¬ä¸€æ¬¡å‘å¸ƒ)ï¼Œåˆ™é»˜è®¤ä¸º v0.0.0
          LATEST_TAG=$(git tag | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1 || echo "v0.0.0")
          echo "æ‰¾åˆ°çš„æœ€æ–°çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ Tag: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒç‰ˆæœ¬å· (Compare versions)
        id: compare
        run: |
          APP_VERSION=${{ steps.pubspec_version.outputs.app_version }}
          LATEST_TAG_VERSION=${{ steps.latest_tag.outputs.tag }}
          LATEST_TAG_VERSION_NUM=${LATEST_TAG_VERSION#v} # å»æ‰ 'v' -> 0.1.0
          
          echo "App ç‰ˆæœ¬ (Current): $APP_VERSION"
          echo "Git Tag ç‰ˆæœ¬ (Latest): $LATEST_TAG_VERSION_NUM"
          
          if [ "$APP_VERSION" = "$LATEST_TAG_VERSION_NUM" ]; then
            echo "::error::pubspec.yaml ç‰ˆæœ¬ ($APP_VERSION) ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–° pubspec.yamlã€‚"
            exit 1
          fi
          
          # ä½¿ç”¨ sort -V æ¥å®‰å…¨åœ°æ¯”è¾ƒç‰ˆæœ¬å·
          LATEST_VERSION=$(printf "%s\n%s" "$APP_VERSION" "$LATEST_TAG_VERSION_NUM" | sort -V | tail -n 1)
          
          if [ "$LATEST_VERSION" != "$APP_VERSION" ]; then
            echo "::error::pubspec.yaml ç‰ˆæœ¬ ($APP_VERSION) å°äºæˆ–ç­‰äºæœ€æ–°çš„ Tag ç‰ˆæœ¬ ($LATEST_TAG_VERSION_NUM)ã€‚è¯·åœ¨å‘å¸ƒå‰æ›´æ–° pubspec.yamlã€‚"
            exit 1
          fi
          
          echo "ç‰ˆæœ¬æ ¡éªŒé€šè¿‡ (Validation passed)!"
          echo "new_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "new_tag=v$APP_VERSION" >> $GITHUB_OUTPUT

  # =======================================================
  # JOB 2: æ„å»ºå¹¶å‘å¸ƒ Release
  # =======================================================
  build_and_release:
    name: 2. æ„å»ºå¹¶å‘å¸ƒ (Build and Release)
    if: github.ref == 'refs/heads/main'
    needs: validate # ä¾èµ– validate job æˆåŠŸ
    runs-on: ubuntu-22.04

    steps:
      - name: å…‹éš†å½“å‰ä»“åº“ (Clone current repo)
        uses: actions/checkout@v6

      - name: å®‰è£… Java (Install Java)
        uses: actions/setup-java@v5
        with:
          distribution: 'liberica'
          java-version: '21'

      - name: å®‰è£… Flutter (Set up Flutter)
        uses: subosito/flutter-action@v2
        with:
          cache: true
          flutter-version-file: "pubspec.yaml"

      - name: Gradle ç¼“å­˜ (Gradle cache)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ‹‰å–ä¾èµ– (flutter pub get)
        run: flutter pub get

      - name: åˆ›å»ºç­¾åé…ç½® (Create signing config)
        env:
          FLUTTER_ANDROID_KEYSTORE_BASE64: ${{ secrets.FLUTTER_ANDROID_KEYSTORE_BASE64 }}
          FLUTTER_KEYSTORE_PASSWORD: ${{ secrets.FLUTTER_KEYSTORE_PASSWORD }}
          FLUTTER_KEY_ALIAS: ${{ secrets.FLUTTER_KEY_ALIAS }}
        run: |
          echo "$FLUTTER_ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/SyncClipboardAndroidKey.jks
          cat > android/key.properties << EOF
          storePassword=$FLUTTER_KEYSTORE_PASSWORD
          keyPassword=$FLUTTER_KEYSTORE_PASSWORD
          keyAlias=$FLUTTER_KEY_ALIAS
          storeFile=SyncClipboardAndroidKey.jks
          EOF

      - name: æ„å»º APK (Build APK)
        run: flutter build apk --release --target-platform android-arm64

      - name: é‡å‘½å APK (Rename APK)
        id: rename_apk
        run: |
          VERSION=${{ needs.validate.outputs.new_version }}
          ORIGINAL_PATH="./build/app/outputs/flutter-apk/app-release.apk"
          NEW_NAME="sync-clipboard-flutter-${VERSION}-arm64.apk"
          mv $ORIGINAL_PATH ./$NEW_NAME
          echo "apk_path=./$NEW_NAME" >> $GITHUB_OUTPUT

      - name: è¯»å– Unreleased Changelog (Read Unreleased Changelog)
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: 'Unreleased' # å‘å¸ƒæ—¶ï¼Œæ–°ç‰ˆæœ¬çš„å†…å®¹ä»åœ¨ Unreleased å—ä¸­
          path: './CHANGELOG.md'

      - name: ç”Ÿæˆ Full Changelog é“¾æ¥ (Generate Full Changelog Link)
        id: changelog_link
        run: |
          echo "url=${{ github.server_url }}/${{ github.repository }}/compare/${{ needs.validate.outputs.old_tag }}...${{ needs.validate.outputs.new_tag }}" >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release (Create GitHub Release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ needs.validate.outputs.new_tag }} # e.g., v0.1.1
          name: ${{ needs.validate.outputs.new_tag }}
          body: |
            ${{ steps.changelog_reader.outputs.description || steps.changelog_reader.outputs.changes }}

            ---
            **Full Changelog**: ${{ steps.changelog_link.outputs.url }}
          prerelease: false # è¿™æ˜¯æ­£å¼ç‰ˆ
          artifacts: ${{ steps.rename_apk.outputs.apk_path }} # ä¸Šä¼ é‡å‘½ååçš„ APK

  # =======================================================
  # JOB 3: æ›´æ–° CHANGELOG å¹¶åˆ›å»º PR
  # =======================================================
  update_changelog:
    name: 3. æ›´æ–° CHANGELOG å¹¶åˆ›å»º PR (Update CHANGELOG)
    if: github.ref == 'refs/heads/main'
    needs: [validate, build_and_release] # å¿…é¡»åœ¨å‘å¸ƒæˆåŠŸåè¿è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: å…‹éš†ä»“åº“ (Checkout repo)
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GITHUB_TOKEN

      - name: é…ç½® Git (Configure Git)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ›´æ–° CHANGELOG.md (Update CHANGELOG.md)
        env:
          NEW_VERSION: ${{ needs.validate.outputs.new_version }}
          NEW_TAG: ${{ needs.validate.outputs.new_tag }}
          OLD_TAG: ${{ needs.validate.outputs.old_tag }}
        run: |
          TODAY=$(date +'%Y-%m-%d')
          REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY" 
          FILE="./CHANGELOG.md"

          # 1. å‡†å¤‡æ–°é“¾æ¥
          NEW_UNRELEASED_LINK_LINE="[Unreleased]: ${REPO_URL}/compare/${NEW_TAG}...HEAD"
          NEW_VERSION_LINK_LINE="[${NEW_VERSION}]: ${REPO_URL}/commits/${NEW_TAG}"

          # 2. æ›¿æ¢ [Unreleased] æ ‡é¢˜ä¸ºæ–°ç‰ˆæœ¬æ ‡é¢˜
          sed -i.bak "s|## \[Unreleased\]|## \[${NEW_VERSION}\] - ${TODAY}|" $FILE

          # 3. åœ¨æ–‡ä»¶ä¸»æ ‡é¢˜ (# ...) ä¸‹æ–¹æ·»åŠ æ–°çš„ [Unreleased] å—
          sed -i.bak "/^# .*/a \\
          \\
          ## [Unreleased]
          " $FILE
          
          # 4. æ›¿æ¢æ—§çš„ Unreleased é“¾æ¥
          sed -i.bak "s|^\[Unreleased\]:.*|${NEW_UNRELEASED_LINK_LINE}|" $FILE
          
          # 5. åœ¨ Unreleased é“¾æ¥ *ä¸‹é¢* æ·»åŠ æ–°ç‰ˆæœ¬çš„é“¾æ¥
          sed -i.bak "/^\[Unreleased\]:/a ${NEW_VERSION_LINK_LINE}" $FILE
          
          # 6. åˆ é™¤å¤‡ä»½æ–‡ä»¶
          rm -f $FILE.bak
          
          echo "--- CHANGELOG.md after update: ---"
          cat $FILE
          echo "-----------------------------------"

      - name: åˆ›å»º PR åˆ° dev åˆ†æ”¯ (Create PR to dev)
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          branch: "chore/update-changelog-${{ needs.validate.outputs.new_version }}"
          base: "dev" # ç›®æ ‡åˆ†æ”¯æ˜¯ dev
          title: "chore: è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}"
          body: |
            è‡ªåŠ¨æ›´æ–° CHANGELOG.md v${{ needs.validate.outputs.new_version }}
          delete-branch: true
