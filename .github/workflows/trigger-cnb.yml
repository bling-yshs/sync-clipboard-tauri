name: üõ†Ô∏è Flutter Ëá™Âä®ÊûÑÂª∫

on:
  push:
  pull_request_target:
    branches:
      - ci/cnb

jobs:
  trigger-cnb-build:
    name: üõ†Ô∏è Ëß¶Âèë cnb ÊûÑÂª∫
    runs-on: ubuntu-22.04

    steps:
      - name: ÈÄâÊã© Checkout ÁõÆÊ†á (Decide repo/ref)
        id: pick
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            # PR Âú∫ÊôØÔºöÁî® PR ÁöÑ head ‰ªìÂ∫ìÂíåÂàÜÊîØ
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT

            # ÂØπÂ∫îÁöÑ git_url Âíå git_branch_name
            echo "git_url=${{ github.event.pull_request.head.repo.clone_url }}" >> $GITHUB_OUTPUT
            echo "git_branch_name=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            # push Âú∫ÊôØÔºöÁî®ÂΩìÂâç‰ªìÂ∫ìÂíåÂàÜÊîØ
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            # github.ref_name ‰ºöÁõ¥Êé•ÁªôÂá∫ÂàÜÊîØÂêçÔºà‰∏çÂ∏¶ refs/heads/Ôºâ
            echo "ref=${{ github.ref_name }}" >> $GITHUB_OUTPUT

            # ÂØπÂ∫îÁöÑ git_url Âíå git_branch_name
            echo "git_url=${{ github.server_url }}/${{ github.repository }}.git" >> $GITHUB_OUTPUT
            echo "git_branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      - name: Ëß¶Âèë cnb ÊûÑÂª∫
        run: |
          curl --location --request POST 'https://api.cnb.cool/bling-team/sync-clipboard-flutter-action/-/build/start' \
          --header 'Content-Type: application/json' \
          --header 'Authorization: Bearer 2wr1e2dMK02brPWije4KWoGKkeC' \
          --data-raw '{
            "branch": "main",
            "env": {
              "git_url": "${{steps.pick.outputs.git_url}}",
              "git_branch": "${{steps.pick.outputs.git_branch_name}}"
            },
            "event": "api_trigger_build"
          }'