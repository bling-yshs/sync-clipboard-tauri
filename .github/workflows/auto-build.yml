name: ðŸ› ï¸ Flutter è‡ªåŠ¨æž„å»º

on:
  workflow_dispatch:
  push:
  pull_request_target:
    branches:
      - dev

jobs:
  build-android:
    name: ðŸ› ï¸ æž„å»º Android
    runs-on: ubuntu-22.04

    steps:
      - name: é€‰æ‹© Checkout ç›®æ ‡ (Decide repo/ref)
        id: pick
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "repo=${{ github.event.pull_request.head.repo.full_name }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          else
            echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v6
        with:
          repository: ${{ steps.pick.outputs.repo }}
          ref: ${{ steps.pick.outputs.ref }}
          fetch-depth: 0
          # PR åœºæ™¯ç¦ç”¨é»˜è®¤ token
          persist-credentials: false

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          detached: true

      - name: å®‰è£… Java (Install Java)
        uses: actions/setup-java@v5
        with:
          distribution: 'liberica'
          java-version: '21'

      - name: å®‰è£… Flutter (Set up Flutter)
        uses: subosito/flutter-action@v2
        with:
          cache: true
          flutter-version-file: "pubspec.yaml"

      - name: æ‹‰å–ä¾èµ– (flutter pub get)
        run: flutter pub get

      # === å¦‚æžœè¦åšç­¾åå‘å¸ƒï¼Œè§£å¼€è¿™ä¸€æ®µå¹¶æŒ‰ä½ çš„ Gradle é…ç½®è°ƒæ•´ ===
      # - name: åˆ›å»º keystore (Create keystore)
      #   env:
      #     ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      #     ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      #   run: |
      #     mkdir -p android
      #     echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/upload-keystore.jks
      #     cat > android/key.properties << EOF
      #     storePassword=$ANDROID_KEYSTORE_PASSWORD
      #     keyPassword=$ANDROID_KEYSTORE_PASSWORD
      #     keyAlias=upload
      #     storeFile=upload-keystore.jks
      #     EOF

      - name: æž„å»º APK (Build APK)
        run: flutter build apk --release --target-platform android-arm64

      - name: ä¸Šä¼ æž„å»ºäº§ç‰© (Upload build artifacts)
        uses: actions/upload-artifact@v5
        with:
          name: android-${{ github.sha }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
          if-no-files-found: error

  upload-to-release-alpha:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/dev' }}
    name: ðŸ“¤ ä¸Šä¼ åˆ° alpha ç‰ˆæœ¬ (Upload to alpha release)
    needs: build-android
    runs-on: ubuntu-22.04

    steps:
      - name: å…‹éš†ä»“åº“ (Checkout repo)
        uses: actions/checkout@v6

      - name: ä¸‹è½½ Artifact (Download Artifact)
        uses: actions/download-artifact@v6
        with:
          path: ./download
          merge-multiple: true

      - name: è¯»å– Unreleased Changelog (Read Unreleased Changelog)
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2.2.3
        with:
          version: "Unreleased"
          path: "./CHANGELOG.md"

      - name: æå– Unreleased å¯¹æ¯”é“¾æŽ¥ (Extract Unreleased Compare Link)
        id: changelog_link
        run: |
          URL=$(grep "\[Unreleased\]:" CHANGELOG.md | awk '{print $2}')
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ ç¼–è¯‘ç»“æžœåˆ° pre-release (Upload build result to pre-release)
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: alpha
          commit: ${{ github.sha }}
          body: |
            ${{ steps.changelog_reader.outputs.description || steps.changelog_reader.outputs.changes }}

            ---
            **Full Changelog**: ${{ steps.changelog_link.outputs.url }}
          allowUpdates: true
          removeArtifacts: true
          prerelease: true
          artifacts: ./download/**/*
